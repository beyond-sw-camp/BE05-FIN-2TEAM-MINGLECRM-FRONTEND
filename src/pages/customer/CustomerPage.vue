<template>
  <div class="q-pa-md">
    <q-input
      clearable
      filled
      color="purple-12"
      v-model="search"
      label="고객명을 입력해주세요"
    />

    <q-table
      flat
      bordered
      title="Customers"
      :rows="filteredRows"
      :columns="columns"
      row-key="id"
      v-model:pagination="pagination"
      @row-click="goToDetails"
    >
      <template v-slot:pagination="scope">
        <q-btn
          v-if="scope.pagesNumber > 2"
          icon="first_page"
          color="grey-8"
          round
          dense
          flat
          :disable="scope.isFirstPage"
          @click="scope.firstPage"
        />
        <q-btn
          icon="chevron_left"
          color="grey-8"
          round
          dense
          flat
          :disable="scope.isFirstPage"
          @click="scope.prevPage"
        />
        <q-btn
          icon="chevron_right"
          color="grey-8"
          round
          dense
          flat
          :disable="scope.isLastPage"
          @click="scope.nextPage"
        />
        <q-btn
          v-if="scope.pagesNumber > 2"
          icon="last_page"
          color="grey-8"
          round
          dense
          flat
          :disable="scope.isLastPage"
          @click="scope.lastPage"
        />
      </template>
    </q-table>
  </div>
</template>

<script>
import { ref, computed, onMounted } from 'vue';
import { useRouter } from 'vue-router';
import axios from 'axios';

const columns = [
  {
    name: 'id',
    label: '#',
    field: 'id',
  },
  {
    name: 'name',
    required: true,
    label: '고객명',
    align: 'left',
    field: row => row.name,
    format: val => `${val}`,
    sortable: true,
  },
  {
    name: 'grade',
    align: 'center',
    label: '등급',
    field: 'grade',
    sortable: true,
  },
  { name: 'phone', label: '전화번호', field: 'phone', sortable: true },
  { name: 'address', label: '주소', field: 'address' },
  { name: 'employee_name', label: '담당자', field: 'employee_name' },
  { name: 'memo', label: '메모', field: 'memo' },
  { name: 'gender', label: '성별', field: 'gender' },
  { name: 'birth', label: '생일', field: 'birth' },
];

export default {
  setup() {
    const router = useRouter();
    const search = ref('');
    const rows = ref([]);
    const pagination = ref({
      rowsPerPage: 10,
    });

    const fetchCustomers = async () => {
      try {
        const response = await axios.get('http://localhost:8080/api/v1/customers');
        console.log(response.data); // 데이터를 콘솔에 출력하여 확인합니다.
        rows.value = response.data.map((customer) => ({
          id: customer.id,
          ...customer,
        }));
      } catch (error) {
        console.error('Error fetching customers:', error);
      }
    };

    const goToDetails = (row) => {
      console.log('Selected row:', row);  // 클릭된 행의 데이터를 콘솔에 출력하여 확인합니다.
      if (row && row.id) {
        router.push({ path: `/mingle/customer-detail/${row.id}` });
      } else {
        console.error('Selected row or row.id is undefined:', row);
      }
    };

    const filteredRows = computed(() => {
      return rows.value.filter(row =>
        row.name.toLowerCase().includes(search.value.toLowerCase())
      );
    });

    onMounted(() => {
      fetchCustomers();
    });

    return {
      columns,
      rows,
      search,
      pagination,
      filteredRows,
      goToDetails,
    };
  },
};
</script>
